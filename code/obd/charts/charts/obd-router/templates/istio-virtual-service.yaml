{{ if .Values.expose.enabled}}
{{- $onboardingHost := printf "%s.%s.svc.cluster.local" ( default ( printf "%s-%s" .Release.Name "router" ) .Values.global.router.fullName ) .Release.Namespace -}}
{{- $applicationHost := printf "%s.%s.svc.cluster.local" ( printf "%s-%s" ( default "susaas" .Values.global.saasRelease ) (default "router" .Values.global.saasRouter)) .Release.Namespace -}}
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ printf "%s-%s" ( default "susaas" .Values.global.saasRelease ) ( uuidv4 | trunc 5) }}
  labels: {{- include "obd-router.labels" . | nindent 4 }}
spec:
  gateways:
    - {{ .Values.global.gateway | default "kyma-system/kyma-gateway"  }}
  hosts:
    # Application domain like susaas.sap-demo.com
    - {{ printf "%s-%s.%s" ( default "susaas" .Values.global.saasRelease ) .Release.Namespace .Values.global.domain }}
    # Onboarding domain like onboarding-susaas.sap-demo.com
    - {{ printf "onboarding-%s-%s.%s" ( default "susaas" .Values.global.saasRelease ) .Release.Namespace .Values.global.domain }}
  http:

    # Handler for the onboarding application ensuring a domain switch
    # Onboarding UI has to be handled by a different 
    - match:
      - uri:
          regex: ^.*(sapsusaasuionboarding).*$
        authority:
          exact: {{ printf "%s-%s.%s" ( default "susaas" .Values.global.saasRelease ) .Release.Namespace .Values.global.domain }}
      redirect:
        authority: {{ printf "onboarding-%s-%s.%s" ( default "susaas" .Values.global.saasRelease ) .Release.Namespace .Values.global.domain }}

    # Handler for all requests targeting the mulitenant SaaS application
    # Requests require the x-custom-host cookie to determine the tenant host
    - match:
      - headers:
          Cookie:
            regex: ^.*(x-custom-host=).*$
        uri:
          regex: ^.*(sapsusaasuipublic|sapsusaasuiadmin|user-api).*$
      # Handle all xsuaa logins via the mulitenant SaaS application router
      - queryParams:
          authType:
            exact: xsuaa
        uri:
          prefix: /login/callback
      route:
        # Route targeting the mulitenant SaaS application router 
        - destination:
            host: {{ $applicationHost }} 
            port:
              number: 5000
          weight: 100
      timeout: 30s
    
    # Handler for all requests targeting the onboarding router/apps
    - match:
      - uri:
          regex: ^.*(sapsusaasuihome|sapsusaasuionboarding).*$
      - uri:
          prefix: /login/callback
      - uri:
          exact: /login
      route:
        - destination:
            host: {{ $onboardingHost }}  
            port:
              number: 5000
          weight: 100
      timeout: 30s

    # Handler for all other requests
    - match:
      - uri:
          regex: .*
      rewrite:
        uri: /
      route:
        - destination:
            host: {{ $onboardingHost }}  
            port:
              number: 5000
          weight: 100
      timeout: 30s
{{ end }}